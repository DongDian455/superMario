## åœ°å›¾ç´ æ
ç»˜åˆ¶åœ°å›¾ä¹‹å‰è¦å…ˆä»‹ç»ä¸€ä¸‹è®¾è®¡åœ°å›¾æ–¹å¼ï¼Œåœ°å›¾ç´ æè¢«åˆ†å‰²ä¸ºä¸¤ç±»ï¼Œä¸€ç±»ä¸ºåœ°å›¾å…ƒç´ ï¼Œä¸€ç±»ä¸ºåœ°å›¾æè¿°

- **åœ°å›¾å…ƒç´ **

![image.png](https://cdn.nlark.com/yuque/0/2023/png/22094584/1692435810496-33652deb-788d-477d-b328-59c4699b7267.png#averageHue=%23ebe7e6&clientId=u256aa399-cdfa-4&from=paste&height=134&id=u3bde68f9&originHeight=268&originWidth=642&originalType=binary&ratio=2&rotation=0&showTitle=false&size=10235&status=done&style=none&taskId=u9663e32f-3108-4aac-9c8f-32c92995411&title=&width=321)
> éœ€è¦æ³¨æ„ï¼šä¸€ä¸ªæ–¹å—çš„å¤§å°ä¸º16ï¼Œè¿™ä¸ªåç»­ä¼šç”¨äºè®¸å¤šåœ°æ–¹çš„è®¡ç®—ã€‚

- **åœ°å›¾æè¿°**

![image.png](https://cdn.nlark.com/yuque/0/2023/png/22094584/1692435742804-cabf80f4-a3e8-440a-84d0-5848f08460b6.png#averageHue=%23e7e4e3&clientId=u256aa399-cdfa-4&from=paste&height=415&id=u3f6d66ec&originHeight=830&originWidth=2044&originalType=binary&ratio=2&rotation=0&showTitle=false&size=62692&status=done&style=none&taskId=ude51a703-b18b-43f6-9bbd-803e724e9e4&title=&width=1022)
åŸä½œè€…è®¾è®¡çš„åœ°å›¾æè¿°ä¸ºä¸€ä¸ªåƒç´ ç±»å‹çš„åœ°å›¾ï¼Œåç»­æ ¹æ®æ¯ä¸ªåƒç´ çš„é¢œè‰²æ¥åŒºåˆ†ä½¿ç”¨å“ªä¸ªåœ°å›¾å®ä½“ï¼Œåœ°å›¾æè¿°åˆ†ä¸º3å±‚ï¼š

- ç¬¬ä¸€å±‚ï¼šæè¿°ç¢°æ’ç‰©çš„ç»˜åˆ¶ä½ç½®
- ç¬¬äºŒå±‚ï¼šæè¿°äººç‰©/æ€ªç‰©çš„å‡ºç”Ÿä½ç½®
- ç¬¬ä¸‰å±‚ï¼šæè¿°èƒŒæ™¯çš„å†…å®¹

## å®šä¹‰åœ°å›¾å…ƒç´ æšä¸¾
æ ¹æ®åœ°å›¾å…ƒç´ ä¸­çš„å†…å®¹ï¼Œé¦–å…ˆå®šä¹‰ç›¸å…³çš„æšä¸¾ç”¨äºæè¿°è¿™äº›å…ƒç´ 
```cpp
enum Cell
{
    ActivatedQuestionBlock, //è¢«æ’å‡»è¿‡çš„ï¼Ÿæ–¹å—
    Brick, //æ™®é€šç –å—
    Coin,  //é‡‘å¸
    Empty, //ç©º
    Pipe, //ç®¡é“
    QuestionBlock, // ï¼Ÿæ–¹å—
    Wall //å¢™ä½“ï¼Œä¸€èˆ¬æŒ‡åœ°æ¿
};
```
> æ³¨æ„è¿™é‡Œåªå®šä¹‰äº†ç¢°æ’ç›¸å…³çš„ï¼ŒèƒŒæ™¯æ˜¯æ²¡æœ‰å®šä¹‰çš„ã€‚

ç”±äºåœ°å›¾çš„å®½åº¦æ˜¯ä¸ç¡®å®šçš„ï¼Œä½†æ˜¯é«˜åº¦æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨`vector+array`ç»„åˆæˆä¸€ä¸ªäºŒç»´å®¹å™¨æ¥ä¿å­˜å…·ä½“çš„ä¿¡æ¯
```cpp
typedef std::vector<std::array<Cell, SCREEN_HEIGHT / CELL_SIZE>> GameMap;
```
## åœ°å›¾å…ƒç´ è§£æ
åœ°å›¾è§£æå°±æ˜¯æ ¹æ®æ‹¿åˆ°çš„å›¾ç‰‡åŒºåŸŸçš„**åƒç´ ç‚¹**è¿›è¡Œè½¬æ¢å¯¹åº”çš„å†…å®¹ï¼Œè¿™é‡Œæ²¡å¿…è¦çº ç»“
```cpp
Cell MapManager::createCellByPixel(sf::Color &pixel)
{

    if (sf::Color(182, 73, 0) == pixel)
    {
        return Cell::Brick;
    }
    else if (sf::Color(255, 255, 0) == pixel)
    {
        return Cell::Coin;
    }
    else if (sf::Color(0, 146, 0) == pixel || sf::Color(0, 182, 0) == pixel || sf::Color(0, 219, 0) == pixel)
    {
        return Cell::Pipe;
    }
    else if (sf::Color(255, 73, 85) == pixel || sf::Color(255, 146, 85) == pixel)
    {
        return Cell::QuestionBlock;
    }
    else if (sf::Color(0, 0, 0) == pixel || sf::Color(146, 73, 0) == pixel)
    {
        return Cell::Wall;
    }
    else
    {
        return Cell::Empty;
    }
}
```
## åœ°å›¾å…ƒç´ ä¸ç»˜åˆ¶åŒºåŸŸ
ç”±äºåŠ è½½Textureçš„æ—¶å€™ä¼šæŠŠæ•´å¼ åœ°å›¾å…ƒç´ åŠ è½½è¿›æ¥ï¼Œä¸åŒå…ƒç´ çš„ç»˜åˆ¶åŒºåŸŸæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚ç¬¬ä¸€ğŸ§±å°±ä½äº`Rect(0,0,16,16)`ï¼Œè€Œè‰åœ°å°±ä½äº`Rect(4*16,0,3*16,16)`
**æ‰€ä»¥è¿™é‡Œä¹Ÿæœ‰ä¸€å±‚ç»˜åˆ¶çš„æ˜ å°„å…³ç³»ï¼š**
```cpp
std::pair<int, int> MapManager::convert_cell_to_rect(const int posX, const int posY)
{
    unsigned short sprite_x = 0;
    unsigned short sprite_y = 0;

    if (Cell::ActivatedQuestionBlock == map[posX][posY])
    {
        sprite_x = 6;
        sprite_y++;
    }
    else if (Cell::Pipe == map[posX][posY])
    {
        if (sf::Color(0, 182, 0) == map_sketch.getPixel(posX, posY))
        {
            sprite_y = 1;

            if (Cell::Pipe == map[posX - 1][posY])
            {
                sprite_x = 11;
            }
            else
            {
                sprite_x = 10;
            }
        }
   //...
   //...     
}
```
> å…·ä½“å¯ä»¥å‚è€ƒæºç ï¼Œè¿™é‡Œä¸åšè¿‡å¤šçš„ä»£ç å±•ç¤ºäº†

## åœ°å›¾ç»˜åˆ¶
æœ‰äº†åœ°å›¾å…ƒç´ ä»¥åŠç»˜åˆ¶åŒºåŸŸä¹‹åï¼Œé‚£ä¹ˆå°±å¯ä»¥çœŸæ­£çš„ç»˜åˆ¶åœ°å›¾äº†ï¼Œæ¯”è¾ƒç®€å•ï¼Œæ ¹æ®å½“å‰å±•ç¤ºçš„åŒºåŸŸåšéå†ç»˜åˆ¶å³å¯
```cpp
void MapManager::draw_map(sf::RenderWindow &i_window)
{
    unsigned short map_end = ceil((SCREEN_WIDTH) / static_cast<float>(CELL_SIZE));
    unsigned short map_start = floor(0 / static_cast<float>(CELL_SIZE));
    unsigned short map_height = floor(static_cast<float>(map_sketch.getSize().y) / MAP_SKETCH_LAYER);

    for (unsigned short a = map_start; a < map_end; a++)
    {
        for (unsigned short b = 0; b < map_height; b++)
        {
            cell_sprite.setPosition(CELL_SIZE * a, CELL_SIZE * b);

            if (Cell::Empty != map[a][b])
            {
                //è·å–è½¬æ¢çš„ç»˜åˆ¶ä½ç½®
                std::pair spritePos = convert_cell_to_rect(a, b);
                //è®¾ç½®çº¹ç†çš„åŒºåŸŸ
                cell_sprite.setTextureRect(sf::IntRect(CELL_SIZE * spritePos.first, CELL_SIZE * spritePos.second, CELL_SIZE, CELL_SIZE));
                //ç»˜åˆ¶ç²¾çµå›¾å±‚
                i_window.draw(cell_sprite);
            }
        }
    }
}
```
**æ•ˆæœå±•ç¤ºï¼š**
![image.png](https://cdn.nlark.com/yuque/0/2023/png/22094584/1692455914504-224992e5-8ffc-4b2c-8495-6f1e8334b56c.png#averageHue=%2300dbfe&clientId=u26789281-333b-4&from=paste&height=498&id=u76bd26b5&originHeight=498&originWidth=639&originalType=binary&ratio=2&rotation=0&showTitle=false&size=15936&status=done&style=none&taskId=u883d4129-feab-489d-a140-8173be710ed&title=&width=639)

## ç»˜åˆ¶èƒŒæ™¯
ç”±äºå‰é¢åªç»˜åˆ¶äº†å…ƒç´ å†…å®¹ï¼Œä½†æ˜¯èƒŒæ™¯æ²¡æœ‰ç»˜åˆ¶ï¼Œè¿˜æ˜¯è€å¥—è·¯ï¼Œæ ¹æ®åœ°å›¾åƒç´ ç‚¹ç»˜åˆ¶å…ƒç´ å†…å®¹ï¼Œä½†æ˜¯å› ä¸ºèƒŒæ™¯åç»­æ— éœ€ç”¨äºç¢°æ’æ£€æµ‹ï¼Œæ‰€ä»¥**ä¸éœ€è¦ä½¿ç”¨å®¹å™¨å­˜å‚¨**ã€‚
**æ·»åŠ èƒŒæ™¯åï¼š**
![image.png](https://cdn.nlark.com/yuque/0/2023/png/22094584/1692456767462-111add5c-9417-4f98-ab5a-68a6a178e946.png#averageHue=%2300d9f6&clientId=u26789281-333b-4&from=paste&height=498&id=ue0dcbdb0&originHeight=498&originWidth=639&originalType=binary&ratio=2&rotation=0&showTitle=false&size=18255&status=done&style=none&taskId=u3b76462c-63f5-4e92-85e1-f2b811f5ea2&title=&width=639)

## ç±»ç»“æ„
å½“å‰å®ç°åœ°å›¾ç»˜åˆ¶çš„`MapManager`ç±»ç»“æ„
```cpp
class MapManager
{
    //åœ°å›¾ä¿¡æ¯
    sf::Image map_sketch;
    //åœ°å›¾ç²¾çµ
    sf::Texture map_texture;
    //å…ƒç´ ç²¾çµ
    sf::Sprite cell_sprite;
	//åœ°å›¾å…ƒç´ ä¿¡æ¯
    GameMap map;

public:
    MapManager();
    //å°†å›¾ç‰‡ç´ æè½¬æ¢æˆå…ƒç´ 
    void convert_map_to_cell(const std::string &filePath);
    //æ ¹æ®åƒç´ è½¬æ¢æˆå¯¹åº”çš„Cell
    Cell createCellByPixel(sf::Color &pixel);

    //è·å–å…ƒç´ çš„ç»˜åˆ¶åŒºåŸŸ
    std::pair<short,short> get_cell_rect(const short posX ,const short posY);
    //è·å–èƒŒæ™¯çš„ç»˜åˆ¶åŒºåŸŸ
    std::pair<short,short> get_bg_rect(const short posX ,const short posY,const short map_height);

    //è·å–æ•´ä¸ªåœ°å›¾å…ƒç´ ä¸ªæ•°
    int get_map_size();
    
    //ç»˜åˆ¶åœ°å›¾
    void draw_map(sf::RenderWindow &i_window,const bool draw_bg);

};

```

